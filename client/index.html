<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MoneyTron ‚Äî Multi-User Money Tracker</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- Day.js + XLSX -->
  <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --ink:#2b2f42;
      --muted:#667085;
      --brand:#6b46c1;
      --card:#ffffff;
      --chipBlue:#dbeafe; --chipBlueText:#1e40af;
      --yellowBg:#fff7ed; --yellowBorder:#fcd19c; --yellowText:#92400e;
      --dangerRow:#fee2e2;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
      color:var(--ink);
      background: radial-gradient(1200px 700px at 80% 20%, #8b5cf6 0%, #6d28d9 55%, #5b21b6 100%);
      background-attachment: fixed;
      overflow-x: hidden;
    }
    .wrap{ width:min(1280px,96vw); margin:24px auto; padding:24px; }
    .title{ font-size:44px; font-weight:800; margin:0 0 16px; text-align:center; color:#eae9ff; text-shadow:0 2px 18px rgba(0,0,0,.35); }
    .frame{ background:rgba(255,255,255,.88); backdrop-filter: blur(6px); border-radius:18px; padding:16px; margin-top:12px; }

    .panel{ background:var(--card); border-radius:16px; padding:20px 24px; box-shadow:0 10px 20px rgb(8 24 71 / 8%); max-width:100%; overflow:auto; }

    .topbar{ display:flex; gap:12px; justify-content:center; align-items:center; margin-bottom:14px; }
    .pill{ border:none; border-radius:999px; padding:10px 16px; background:linear-gradient(180deg,#7c3aed,#6d28d9); color:#fff; font-weight:700; box-shadow:0 6px 14px rgba(91,33,182,.35); transition:transform .12s, box-shadow .12s; }
    .pill:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(91,33,182,.35); }
    .pill.welcome{ cursor:default; box-shadow:none; }
    .pill.welcome:hover{ transform:none; box-shadow:none; }
    .ghost{ background:#eef2ff; color:#3949ab; box-shadow:none; font-weight:600; }
    .ghost:hover{ filter:brightness(.98); transform:translateY(-1px); }

    .tabs{ display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin:10px 0 18px; }
    .tab{ position:relative; overflow:hidden; border:none; border-radius:999px; padding:10px 18px; background:#f2f3ff; color:#3d2c7a; font-weight:700; box-shadow:inset 0 0 0 1px #ecebff; transition:all .2s; }
    .tab:hover{ transform:translateY(-1px); box-shadow:0 6px 12px rgba(91,33,182,.12); }
    .tab.active{ background:linear-gradient(180deg,#7c3aed,#6d28d9); color:#fff; box-shadow:0 6px 14px rgba(91,33,182,.35); }
    .tab::after{ content:""; position:absolute; top:0; left:-120%; width:60%; height:100%;
      background:linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.7) 48%, rgba(255,255,255,0) 100%);
      transform:skewX(-25deg); transition:left .35s; pointer-events:none; }
    .tab:hover::after{ left:160%; }

    .section-title{ display:flex; align-items:center; gap:10px; font-size:24px; font-weight:800; margin:8px 0 6px; color:#30334b; }
    .section-sub{ color:#667085; font-size:14px; margin:0 0 12px; }
    .thin-underline{ height:2px; background:linear-gradient(90deg,#7c3aed,#6d28d9); border-radius:999px; width:100%; margin:4px 0 10px; opacity:.55; }

    .kpis{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin:10px 0 16px; }
    .kpi{ border-radius:16px; padding:16px; color:#fff; font-weight:800; text-align:center; }
    .k1{ background:linear-gradient(180deg,#6a38c2,#4b2aa9); }
    .k2{ background:linear-gradient(180deg,#15978a,#0d7662); }
    .k3{ background:linear-gradient(180deg,#e6762c,#b85916); }
    .k4{ background:linear-gradient(180deg,#d23a52,#aa2340); }
    .kpi .n{ font-size:28px; display:block; margin-top:2px; }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{ border:none; border-radius:12px; padding:10px 14px; font-weight:700; background:#ecebff; color:#352b7a; transition:transform .12s, box-shadow .12s, filter .12s; }
    .btn:hover{ transform:translateY(-1px); filter:brightness(.98); box-shadow:0 6px 14px rgba(91,33,182,.12); }
    .btn.primary{ background:linear-gradient(180deg,#7c3aed,#6d28d9); color:#fff; box-shadow:0 6px 14px rgba(91,33,182,.35); }
    .btn.danger{ background:#fee2e2; color:#991b1b; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; filter:grayscale(.1); }

    table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    thead th{ font-size:13px; letter-spacing:.3px; font-weight:800; color:#f2f1ff;
      background:linear-gradient(180deg,#6b46c1,#49308d); padding:10px 12px; user-select:none; cursor:pointer; }
    thead th.nosort{ cursor:default; }
    tbody td{ background:#fff; padding:10px 12px; color:#2d2f44; box-shadow:0 2px 6px rgba(16,24,40,.08); vertical-align:middle; text-align:center; }
    tbody tr td:first-child{ border-radius:10px 0 0 10px; text-align:left; }
    tbody tr td:last-child{ border-radius:0 10px 10px 0; }
    .row-vi td{ background:var(--dangerRow)!important; color:#7f1d1d; }

    input[type="text"], input[type="number"], select{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font-family:inherit; font-size:14px; text-align:center; }
    .locked{ background:#f9fafb; } /* readOnly visuals */
    .type-pill{ border:none; border-radius:999px; padding:8px 14px; font-weight:800; cursor:pointer; box-shadow:0 3px 10px rgba(0,0,0,.08); }
    .type-exp{ background:#fee2e2; color:#991b1b; }
    .type-inc{ background:#dcfce7; color:#065f46; }
    .currency-toggle{ border:none; border-radius:10px; padding:6px 8px; margin-right:6px; font-weight:800; background:#eef2ff; color:#352b7a; cursor:pointer; }

    .toolbar{ display:grid; grid-template-columns:1fr auto 1fr; gap:12px; align-items:center; }
    .toolbar .left{ display:flex; gap:8px; align-items:center; }
    .toolbar .middle{ display:flex; flex-direction:column; align-items:center; }
    .toolbar .right{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }
    .input-xs{ padding:8px 10px; font-size:14px; min-width:220px; }
    .btn-xs{ padding:8px 12px; font-size:14px; border-radius:999px; }

    .badge{ display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; background:#ede9fe; color:#5b21b6; font-weight:800; font-size:12px; }
    .cat-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; }
    @media (max-width:900px){ .cat-grid{ grid-template-columns:1fr; } }
    .cat-card{ border-radius:16px; padding:14px; background:#fff; box-shadow:0 8px 16px rgba(16,24,40,.08); }
    .cat-head{ display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .cat-name{ font-weight:800; font-size:18px; color:#2c2761; }
    .chip{ display:inline-flex; align-items:center; gap:6px; background:var(--chipBlue); color:var(--chipBlueText); border-radius:999px; padding:6px 10px; font-weight:700; margin:4px; }
    .chip a{ color:#991b1b; text-decoration:none; }

    .muted{ color:#667085; font-size:13px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:1000px){ .grid-2{ grid-template-columns:1fr; } }

    .chart-box{ position:relative; width:100%; height:340px; }

    /* Settings ‚Äì Data management grid */
    .dm-grid{ display:grid; grid-template-columns:1fr auto; gap:16px; align-items:flex-start; }
    .dm-left{ display:flex; gap:12px; flex-wrap:wrap; }
    .dm-right{ display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
    @media (max-width:700px){ .dm-grid{ grid-template-columns:1fr; } .dm-right{ align-items:flex-start; } }
    .danger-caption{ display:inline-flex; align-items:center; gap:8px; color:#b45309; background:#fff7ed; border:1px dashed #fcd19c; border-radius:10px; padding:8px 10px; font-weight:700; width:max-content; }

    /* --------- Column widths & behaviors --------- */
    .w-tag{ width:56px; min-width:56px; }
    .w-date{ min-width:160px; }
    .w-name{ min-width:150px; max-width:180px; }
    .cell-hscroll{ max-width:180px; margin:0 auto; overflow-x:hidden; white-space:nowrap; }
    .cell-hscroll:hover{ overflow-x:auto; }
    .ro-name{ display:inline-block; padding:8px 10px; }
    input.fit{ width:max-content; text-align:center; }

    .w-amt{ min-width:150px; }
    .w-debit{ min-width:150px; }
    .num-input{ width:120px; }

    .w-cat{ min-width:132px; }
    .w-sub{ min-width:150px; }
    .w-notes{ min-width:240px; }

    /* NEW: read-only tag pill for uploaded rows */
    .ro-tag{
      display:inline-block;
      min-width:40px;
      padding:6px 10px;
      border-radius:10px;
      background:#eef2ff;
      color:#352b7a;
      font-weight:800;
      text-align:center;
    }
  </style>
</head>
<body>
  <div id="root" class="wrap"></div>

  <script type="text/babel" data-presets="react">
/* =============================== API =============================== */
var API=(function(){
  var base='/api';
  function j(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  function f(m,u,b){ var o={method:m,credentials:'include',headers:{}}; if(b){o.headers['Content-Type']='application/json';o.body=JSON.stringify(b);} return fetch(base+u,o); }
  return {
    users:()=>f('GET','/users').then(j),
    login:(user)=>f('POST','/login',{user}).then(j),
    current:()=>f('GET','/current-user').then(j),
    bootstrap:()=>f('GET','/bootstrap').then(j),
    logout:()=>f('POST','/logout').then(j),
    getCategories:()=>f('GET','/categories').then(j),
    saveCategories:(c)=>f('POST','/categories',{categories:c}).then(j),
    getStage:()=>f('GET','/current-month').then(j),
    saveStage:(rows)=>f('POST','/current-month',{transactions:rows}).then(j),
    getPast:()=>f('GET','/past-data').then(j),
    savePast:(rows)=>f('POST','/past-data',{past_data:rows}).then(j),
    saveTransactions:(rows)=>f('POST','/transactions',{transactions:rows}).then(j),
    getSettings:()=>f('GET','/settings').then(j),
    saveSettings:(settings)=>f('POST','/settings',{settings}).then(j),
    importData:(payload)=>f('POST','/import',payload).then(j),
    clearAll:()=>f('POST','/clear-all').then(j),
  };
})();

/* ======================= Helpers ======================= */
function asArray(x){ if(Array.isArray(x)) return x; if(x && Array.isArray(x.items)) return x.items; if(x && Array.isArray(x.data)) return x.data; return []; }
function asCategories(x){ if(x && typeof x==='object' && !Array.isArray(x)) return x; if(Array.isArray(x)){var o={}; x.forEach(it=>{ if(typeof it==='string') o[it]=[]; else if(it && it.name) o[it.name]=Array.isArray(it.subcategories)?it.subcategories.slice():[]; }); return o;} return {}; }
function parseAmount(v){ var s=String(v==null?'':v).replace(/[‚Ç™$,‚Ç¨¬£,\s]/g,''); var neg=/^\(.*\)$/.test(s); if(neg) s=s.replace(/^\(|\)$/g,''); var n=Number(s.replace(/,/g,'')); if(!isFinite(n)) n=0; return neg?-Math.abs(n):n; }
function parseDateAny(v){ if(v==null||v==='') return null; if(typeof v==='number'){ try{var o=XLSX.SSF.parse_date_code(v); if(o) return dayjs(new Date(o.y,(o.m||1)-1,o.d||1)).format('YYYY-MM-DD');}catch(_){}} var fmts=["YYYY-MM-DD","DD/MM/YYYY","DD-MM-YYYY","D/M/YYYY","M/D/YYYY","YYYY/M/D"]; for(var i=0;i<fmts.length;i++){ var d=dayjs(String(v),fmts[i],true); if(d.isValid()) return d.format('YYYY-MM-DD'); } var d2=dayjs(String(v)); return d2.isValid()?d2.format('YYYY-MM-DD'):null; }

/* ================== File parsing (v6-like) ================== */
function extractFromSheet_v6(aoa){
  var hdr=-1,map={date:-1,name:-1,t:-1,db:-1};
  var keys={date:[/◊™◊ê◊®◊ô◊ö/],name:[/◊©◊ù◊ë◊ô◊™◊¢◊°◊ß/,/◊©◊ù.*◊¢◊°◊ß/],t:[/◊°◊õ◊ï◊ù◊¢◊°◊ß◊î/,/◊¢◊°◊ß◊î.*◊°◊õ◊ï◊ù/],db:[/◊°◊õ◊ï◊ù◊ó◊ô◊ï◊ë/,/◊ó◊ô◊ï◊ë.*◊°◊õ◊ï◊ù/]};
  function normHeb(s){return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[^\u0590-\u05FFa-z0-9]/g,'');}
  for(var r=0;r<Math.min(10,aoa.length);r++){
    var row=aoa[r]||[], norm=row.map(normHeb);
    function find(rx){ for(var c=0;c<norm.length;c++){ for(var k=0;k<rx.length;k++){ if(rx[k].test(norm[c])) return c; } } return -1; }
    var cd=find(keys.date), cn=find(keys.name), ct=find(keys.t), cb=find(keys.db);
    if(cd>=0||cn>=0||ct>=0||cb>=0){ hdr=r; map={date:cd,name:cn,t:ct,db:cb}; break; }
  }
  if(hdr<0){
    hdr=0; var cols=(aoa[0]||[]).length, bestD=-1,bestN=-1,bestA1=-1,bestA2=-1,maxD=-1,maxN=-1,maxA1=-1,maxA2=-1;
    for(var c=0;c<cols;c++){
      var dC=0,nC=0,aC=0;
      for(var r2=0;r2<Math.min(80,aoa.length);r2++){
        var cell=aoa[r2]&&aoa[r2][c];
        if(parseDateAny(cell)) dC++;
        var s=String(cell||''); if(s && !isFinite(Number(s))) nC++;
        if(isFinite(parseAmount(cell)) && parseAmount(cell)!==0) aC++;
      }
      if(dC>maxD){maxD=dC; bestD=c;} if(nC>maxN){maxN=nC; bestN=c;} if(aC>maxA1){maxA1=aC; bestA1=c;}
    }
    for(var c2=0;c2<cols;c2++){
      if(c2===bestA1) continue;
      var a2=0; for(var r3=0;r3<Math.min(80,aoa.length);r3++){ var cell2=aoa[r3]&&aoa[r3][c2]; if(isFinite(parseAmount(cell2)) && parseAmount(cell2)!==0) a2++; }
      if(a2>maxA2){maxA2=a2; bestA2=c2;}
    }
    map={date:bestD,name:bestN,t:bestA1,db:bestA2};
  }
  var out=[];
  for(var r=hdr+1;r<aoa.length;r++){
    var row=aoa[r]||[];
    var date=map.date>=0?parseDateAny(row[map.date]):null;
    var name=map.name>=0?String(row[map.name]||'').trim():'';
    var tAmt=map.t>=0?parseAmount(row[map.t]):0;
    var dAmt=map.db>=0?parseAmount(row[map.db]):(tAmt||0);
    if(!date||!name||(!tAmt&&!dAmt)) continue;
    out.push({date:date,name:name,amount:Math.abs(tAmt||0),debit:Number(dAmt||0)});
  }
  return out;
}
function extractFromWorkbook_v6(file){
  return new Promise(function(res,rej){
    var reader=new FileReader();
    reader.onload=function(e){
      try{
        var data=new Uint8Array(e.target.result);
        var wb=XLSX.read(data,{type:'array'}); var all=[];
        wb.SheetNames.forEach(function(sn){
          var ws=wb.Sheets[sn]; if(!ws) return;
          var aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:''});
          if(!aoa||!aoa.length) return; all=all.concat(extractFromSheet_v6(aoa));
        });
        res(all);
      }catch(err){ rej(err); }
    };
    reader.onerror=rej; reader.readAsArrayBuffer(file);
  });
}

/* ================= Components ================= */
function TitleBar({user,onSwitch}){ return (
  <div className="topbar">
    <div className="pill welcome">Welcome, {user}!</div>
    <button className="ghost btn" onClick={onSwitch}>Switch User</button>
  </div>
);}

function LoginView({onLogin}){
  const ref=React.useRef(null);
  function doLogin(){ var n=(ref.current&&ref.current.value||'').trim(); if(!n) return; onLogin(n); }
  return (
    <div className="wrap">
      <h1 className="title">MoneyTron ‚Äî Multi-User Money Tracker</h1>
      <div className="panel frame" style={{maxWidth:900, margin:'0 auto'}}>
        <div className="topbar" style={{marginBottom:16}}>
          <input ref={ref} type="text" placeholder="Enter your name (e.g., Roy)" style={{width:300}} onKeyDown={(e)=>{if(e.key==='Enter') doLogin();}}/>
          <button className="pill" onClick={doLogin}>Login</button>
        </div>
      </div>
    </div>
  );
}

/* ---------- Categories ---------- */
function CategoryCard({cat, subs, onDeleteCat, onAddSub, onDeleteSub}){
  const [subInput,setSubInput]=React.useState('');
  function add(){ if(subInput.trim()){ onAddSub(cat, subInput.trim()); setSubInput(''); } }
  return (
    <div className="cat-card" dir="auto">
      <div className="cat-head">
        <div className="cat-name" dir="auto">{cat}</div>
        <span className="badge">{(subs||[]).length} subcategories</span>
        <div style={{flex:1}}></div>
        <button className="btn btn-xs danger" onClick={()=>onDeleteCat(cat)}>Delete</button>
      </div>
      <div>
        <div>{(!subs || subs.length===0) && <div className="muted">No subcategories yet.</div>}
          {(subs||[]).map(s=>(
            <span className="chip" key={s} dir="auto">{s}
              <a href="#" onClick={(e)=>{e.preventDefault(); onDeleteSub(cat,s);}} title="Remove">√ó</a>
            </span>
          ))}
        </div>
        <div className="controls" style={{marginTop:8}}>
          <input className="input-xs" type="text" placeholder={'Add subcategory to '+cat} value={subInput} onChange={(e)=>setSubInput(e.target.value)} onKeyDown={(e)=>{if(e.key==='Enter') add();}}/>
          <button className="btn btn-xs" onClick={add}>+ Add</button>
        </div>
      </div>
    </div>
  );
}
function CategoriesTab({user, categories, onSaved}){
  const [cats,setCats]=React.useState(categories||{});
  const [q,setQ]=React.useState(''); const [newCat,setNewCat]=React.useState('');
  React.useEffect(()=>setCats(categories||{}),[categories]);
  const names=React.useMemo(()=>Object.keys(cats).sort((a,b)=>a.localeCompare(b)),[cats]);
  const totalCats=names.length, totalSubs=names.reduce((a,c)=>a+(cats[c]?cats[c].length:0),0), avgPer=totalCats?totalSubs/totalCats:0;
  function persist(next){ setCats(next); API.saveCategories(next).catch(()=>{}); onSaved && onSaved(next); }
  function refresh(){ API.getCategories().then(s=>{ setCats(s||{}); onSaved && onSaved(s||{}); }); }
  function addCategory(){ const name=newCat.trim(); if(!name) return; if(cats[name]){alert('Category exists'); return;} persist(Object.assign({},cats,{[name]:[]})); setNewCat(''); }
  function deleteCategory(c){ if(!confirm('Delete category "'+c+'"?')) return; const n=Object.assign({},cats); delete n[c]; persist(n); }
  function addSub(c,s){ if(!s.trim()) return; const arr=(cats[c]||[]).slice(); if(arr.indexOf(s)!==-1){alert('Sub exists'); return;} arr.push(s); persist(Object.assign({},cats,{[c]:arr})); }
  function delSub(c,s){ persist(Object.assign({},cats,{[c]:(cats[c]||[]).filter(x=>x!==s)})); }
  const filtered=React.useMemo(()=>{ const x=q.trim().toLowerCase(); if(!x) return names; return names.filter(c=>c.toLowerCase().includes(x) || (cats[c]||[]).some(s=>String(s).toLowerCase().includes(x))); },[q,names,cats]);
  return (
    <React.Fragment>
      <div className="section-title">üè∑Ô∏è Category Management for {user}</div>
      <div className="kpis">
        <div className="kpi k1">Categories<span className="n">{totalCats}</span></div>
        <div className="kpi k2">Subcategories<span className="n">{totalSubs}</span></div>
        <div className="kpi k3">Avg per Category<span className="n">{avgPer.toFixed(1)}</span></div>
      </div>
      <div className="panel" style={{marginBottom:12}}>
        <div className="toolbar">
          <div className="left"><input className="input-xs" type="text" placeholder="Search Categories & Subcategories" value={q} onChange={(e)=>setQ(e.target.value)}/></div>
          <div className="middle"><button className="btn btn-xs" onClick={refresh}>‚Üª Refresh Categories</button><div className="muted">Update from server</div></div>
          <div className="right"><input className="input-xs" type="text" placeholder="Category name (e.g., Food, Transport)" value={newCat} onChange={(e)=>setNewCat(e.target.value)} onKeyDown={(e)=>{if(e.key==='Enter') addCategory();}}/><button className="btn btn-xs primary" onClick={addCategory}>Add</button></div>
        </div>
      </div>
      <div className="cat-grid">
        {filtered.length===0 && <div className="panel" style={{gridColumn:'1 / -1'}}>No categories match your search.</div>}
        {filtered.map(c=><CategoryCard key={c} cat={c} subs={cats[c]||[]} onDeleteCat={deleteCategory} onAddSub={addSub} onDeleteSub={delSub}/>)}
      </div>
    </React.Fragment>
  );
}

/* ---------- Transactions ---------- */
function TransactionsTab({rows,setRows,categories,onSaved}){
  const [msg,setMsg]=React.useState(''); const [sortKey,setSortKey]=React.useState('date'); const [sortDir,setSortDir]=React.useState('asc');
  function addManual(){
    const r={ id:'m_'+Date.now(), tag:Number(dayjs().format('M')), date:dayjs().format('YYYY-MM-DD'),
      name:'', amount:0, debit:0, currency:'ILS', type:'Expense', category:'', subcategory:'', notes:'', vi:false, manual:true };
    const next=[r].concat(rows); setRows(next); API.saveStage(next).catch(()=>{});
  }
  async function onUpload(e){
    const f=e.target.files && e.target.files[0]; if(!f) return;
    try{
      var suggested=Number(dayjs().format('M'));
      var tgStr=window.prompt('Enter month tag (1‚Äì12)', String(suggested));
      var tag=Number(tgStr); if(!isFinite(tag)||tag<1||tag>12) tag=suggested;
      const extracted=await extractFromWorkbook_v6(f);
      const built=extracted.map((x,i)=>({
        id:'u_'+i+'_'+Date.now(), tag:tag, date:x.date, name:x.name,
        amount:Math.abs(Number(x.amount||0)), debit:Number(x.debit||0),
        currency:'ILS', type:'Expense', category:'', subcategory:'', notes:'', vi:false, manual:false
      }));
      setRows(built); setMsg('‚úÖ '+built.length+' transactions ready'); await API.saveStage(built);
    }catch(err){ alert('Parse failed: '+err.message); }
    e.target.value='';
  }
  function saveAll(){
    if(!rows.length){ alert('No transactions to save'); return; }
    const need = rows.some(r=>!r.subcategory); if(need){ alert('Please set Sub-category for all rows'); return; }
    API.saveTransactions(rows).then(()=>{ setRows([]); setMsg(''); onSaved(); }).catch(err=>alert('Save failed: '+err.message));
  }
  function patch(id,patch){ const i=rows.findIndex(r=>r.id===id); if(i<0) return; const next=rows.slice(); next[i]=Object.assign({},next[i],patch); setRows(next); API.saveStage(next).catch(()=>{}); }
  function delRow(id){ const next=rows.filter(r=>r.id!==id); setRows(next); API.saveStage(next).catch(()=>{}); }
  function toggleType(id){ const r=rows.find(x=>x.id===id); if(!r) return; patch(id,{type:r.type==='Expense'?'Income':'Expense'}); }
  // Toggle currency is now strictly visual: only changes the symbol, not the value
  function toggleCurrency(id){ const r=rows.find(x=>x.id===id); if(!r) return; const next=(r.currency||'ILS')==='ILS'?'USD':'ILS'; patch(id,{currency:next}); }
  function onAmount(id,val){ const r=rows.find(x=>x.id===id); if(!r) return; const amt=Number(val||0); patch(id,{amount:amt}); }
  const needCat = rows.filter(r=>!r.subcategory).length; const categorized=rows.length-needCat;
  const totalSigned=rows.reduce((a,r)=>a+(r.type==='Income'?-Number(r.debit||0):Number(r.debit||0)),0);
  function setSort(k){ if(sortKey===k) setSortDir(sortDir==='asc'?'desc':'asc'); else { setSortKey(k); setSortDir('asc'); } }
  function v(r,k){ switch(k){ case 'tag':return Number(r.tag||0); case 'date':return String(r.date||''); case 'name':return String(r.name||'').toLowerCase(); case 'amount':return Number(r.amount||0); case 'debit':return Number(r.debit||0); case 'type':return String(r.type||''); case 'category':return String(r.category||'').toLowerCase(); case 'subcategory':return String(r.subcategory||'').toLowerCase(); case 'notes':return String(r.notes||'').toLowerCase(); case 'vi':return r.vi?1:0; default:return ''; } }
  const view=React.useMemo(()=>{ const a=rows.slice(); a.sort((x,y)=>{ const vx=v(x,sortKey), vy=v(y,sortKey); const c=(typeof vx==='number'&&typeof vy==='number')?(vx-vy):(vx<vy?-1:vx>vy?1:0); return sortDir==='asc'?c:-c; }); return a; },[rows,sortKey,sortDir]);
  function hdr(lbl,key,cls){ const ar=sortKey===key?(sortDir==='asc'?' ‚Üë':' ‚Üì'):' ‚Üë‚Üì'; return <th className={cls||''} onClick={()=>setSort(key)}>{lbl}{ar}</th>; }
  // Delete all transactions handler
  async function deleteAllTransactions() {
    if (!rows.length) { alert('No transactions to delete'); return; }
    if (!window.confirm('Are you sure you want to delete all current (last upload) transactions?')) return;
    try {
      await fetch('/api/current-month/reset', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User': localStorage.getItem('user') } });
      setRows([]);
      setMsg('All current month transactions deleted.');
    } catch (err) {
      alert('Failed to delete: ' + (err.message || err));
    }
  }
  return (
    <React.Fragment>
      {msg && <div className="panel" style={{marginBottom:12}}>{msg}</div>}
      <div className="kpis">
        <div className="kpi k1">Total Transactions<span className="n">{rows.length}</span></div>
        <div className="kpi k2">Total Amount<span className="n">‚Ç™{totalSigned.toFixed(2)}</span></div>
        <div className="kpi k3">Categorized<span className="n">{categorized}</span></div>
        <div className="kpi k4">Need Categories<span className="n">{needCat}</span></div>
      </div>

      <div className="controls" style={{marginBottom:10}}>
        <label className="btn">üìÅ Upload
          <input type="file" accept=".xlsx,.xls,.csv" style={{display:'none'}} onChange={onUpload}/>
        </label>
        <button className="btn" onClick={addManual}>+ Add Manual Row</button>
        <button className="btn danger" style={{marginLeft:10}} onClick={deleteAllTransactions}>üóëÔ∏è Delete All</button>
        <div style={{flex:1}}></div>
        <button className="btn primary" onClick={saveAll}>üíæ Save All</button>
      </div>

      <div className="panel">
        <table>
          <thead><tr>
            <th className="nosort">‚úñ</th>
            {hdr('Tag','tag','w-tag')}
            {hdr('Date','date','w-date')}
            {hdr('Name','name','w-name')}
            {hdr('Transaction Amount','amount','w-amt')}
            {hdr('Debit Amount (ILS)','debit','w-debit')}
            {hdr('Type','type')}
            {hdr('Category','category','w-cat')}
            {hdr('Sub-category','subcategory','w-sub')}
            {hdr('Notes','notes','w-notes')}
            {hdr('Vi','vi')}
          </tr></thead>
          <tbody>
            {view.length? view.map(r=>{
              const id=r.id || (r.tag+'_'+r.date+'_'+r.name);
              const manual=!!r.manual; const currency=r.currency||'ILS';
              return (
                <tr key={id} className={r.vi?'row-vi':''}>
                  <td style={{width:48}}><button className="btn danger" onClick={()=>delRow(id)}>‚úñ</button></td>

                  <td className="w-tag">
                    {manual
                      ? <input type="number" value={(r.tag==null?'':r.tag)} onChange={(e)=>patch(id,{tag:Number(e.target.value||0)})}/>
                      : <span className="ro-tag" title="Month tag">{(r.tag==null||r.tag===0)?'‚Äî':r.tag}</span>}
                  </td>

                  <td className="w-date">
                    <input className={!manual?'locked':''} readOnly={!manual} type="text" value={r.date||''} onChange={(e)=>patch(id,{date:e.target.value})}/>
                  </td>

                  <td className="w-name" style={{textAlign:'center'}}>
                    {manual
                      ? <div className="cell-hscroll"><input className="fit" type="text" value={r.name||''} title={r.name||''} onChange={(e)=>patch(id,{name:e.target.value})}/></div>
                      : <div className="cell-hscroll ro-name" title={r.name||''}>{r.name||''}</div>}
                  </td>

                  <td className="w-amt">
                    <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
                      <button className="currency-toggle" onClick={()=>toggleCurrency(id)}>{currency==='USD'?'$':'‚Ç™'}</button>
                      <input className={(manual?'':'locked ')+'num-input'} readOnly={!manual} type="number" step="0.01" value={r.amount||0} onChange={(e)=>onAmount(id,e.target.value)}/>
                    </div>
                  </td>

                  <td className="w-debit">
                    <input className="num-input" type="number" step="0.01" value={r.debit||0} onChange={(e)=>patch(id,{debit:Number(e.target.value||0)})}/>
                  </td>

                  <td><button className={'type-pill '+(r.type==='Expense'?'type-exp':'type-inc')} onClick={()=>toggleType(id)}>{r.type}</button></td>
                  <td className="w-cat"><select value={r.category||''} onChange={(e)=>patch(id,{category:e.target.value, subcategory:''})}><option value="">‚Äî Select ‚Äî</option>{Object.keys(categories).map(c=><option key={c} value={c}>{c}</option>)}</select></td>
                  <td className="w-sub"><select value={r.subcategory||''} onChange={(e)=>patch(id,{subcategory:e.target.value})}><option value="">‚Äî</option>{(categories[r.category]||[]).map(s=><option key={s} value={s}>{s}</option>)}</select></td>
                  <td className="w-notes" style={{textAlign:'left'}}><input type="text" value={r.notes||''} onChange={(e)=>patch(id,{notes:e.target.value})}/></td>
                  <td><input type="checkbox" checked={!!r.vi} onChange={(e)=>patch(id,{vi:e.target.checked})}/></td>
                </tr>
              );
            }) : <tr><td colSpan="11" style={{textAlign:'center',color:'#6b7280'}}>No Transactions Yet</td></tr>}
          </tbody>
        </table>
      </div>
    </React.Fragment>
  );
}

/* ---------- Data ---------- */









/* ---------- Data (PAST) ‚Äî with filters for Tag, Category, Sub-category, Name ---------- */
function DataTab({past,categories,onSaved}){
  const [rows,setRows]=React.useState(Array.isArray(past)?past.slice():[]);
  const [q,setQ]=React.useState(''); const [sortKey,setSortKey]=React.useState('date'); const [sortDir,setSortDir]=React.useState('asc'); const [saving,setSaving]=React.useState(false);
  React.useEffect(()=>setRows(Array.isArray(past)?past.slice():[]),[JSON.stringify(past||[])]);
  const totalTx=rows.length; const totalOutcome=rows.reduce((a,r)=>a+(String(r.type||'').toLowerCase()==='income'?0:Number(r.debit||0)),0); const catCount=Object.keys(categories||{}).length; 
  const activeMonths=(function(list){var s={}; list.forEach(r=>{var t=String(r.tag||''); if(t&&t!=='0') s[t]=1;}); return Object.keys(s).length;})(rows);
  // Single filter: select column and enter value
  const [filterCol, setFilterCol] = React.useState('');
  const [filterVal, setFilterVal] = React.useState('');
  function patch(id,p){ const i=rows.findIndex(r=>r.id===id); if(i<0) return; const n=rows.slice(); n[i]=Object.assign({},n[i],p); setRows(n); }
  function delRow(id){ setRows(rows.filter(r=>r.id!==id)); }
  function toggleType(id){ const r=rows.find(x=>x.id===id); if(!r) return; patch(id,{type:r.type==='Expense'?'Income':'Expense'}); }
  // Toggle currency is now strictly visual: only changes the symbol, not the value
  function toggleCurrency(id) {
    const r = rows.find(x => x.id === id); if (!r) return;
    const next = (r.currency || 'ILS') === 'ILS' ? 'USD' : 'ILS';
    patch(id, { currency: next });
  }
  function onAmount(id,val){ const r=rows.find(x=>x.id===id); if(!r) return; const amt=Number(val||0); patch(id,{amount:amt}); }
  function save(){ setSaving(true); API.savePast(rows).then(()=>{ setSaving(false); onSaved && onSaved(rows); alert('Past data updated.'); }).catch(e=>{ setSaving(false); alert('Save failed: '+e.message); }); }
  function setSort(k){ if(sortKey===k) setSortDir(sortDir==='asc'?'desc':'asc'); else { setSortKey(k); setSortDir('asc'); } }
  function v(r,k){ switch(k){ case 'tag':return Number(r.tag||0); case 'date':return String(r.date||''); case 'name':return String(r.name||'').toLowerCase(); case 'amount':return Number(r.amount||0); case 'debit':return Number(r.debit||0); case 'type':return String(r.type||''); case 'category':return String(r.category||'').toLowerCase(); case 'subcategory':return String(r.subcategory||'').toLowerCase(); default:return ''; } }
  const filtered = React.useMemo(() => {
    const x = (q || '').trim().toLowerCase();
    return (rows || []).filter(r => {
      // Text search (q)
      const matchText = !x || [
        r.date, r.name, r.notes, r.category, r.subcategory, r.tag
      ].some(v => String(v == null ? '' : v).toLowerCase().includes(x));
      // Single column filter
      let matchCol = true;
      if (filterCol && filterVal.trim()) {
        const val = String(filterVal).toLowerCase();
        switch (filterCol) {
          case 'tag': matchCol = String(r.tag == null ? '' : r.tag).toLowerCase().includes(val); break;
          case 'name': matchCol = String(r.name == null ? '' : r.name).toLowerCase().includes(val); break;
          case 'category': matchCol = String(r.category == null ? '' : r.category).toLowerCase().includes(val); break;
          case 'subcategory': matchCol = String(r.subcategory == null ? '' : r.subcategory).toLowerCase().includes(val); break;
          default: matchCol = true;
        }
      }
      return matchText && matchCol;
    });
  }, [rows, q, filterCol, filterVal]);
  // No longer need tagOptions, catOptions, subOptions, nameOptions
  const view=React.useMemo(()=>{ const a=filtered.slice(); a.sort((x,y)=>{ const vx=v(x,sortKey), vy=v(y,sortKey); const c=(typeof vx==='number'&&typeof vy==='number')?(vx-vy):(vx<vy?-1:vx>vy?1:0); return sortDir==='asc'?c:-c; }); return a; },[filtered,sortKey,sortDir]);
  function hdr(lbl,key,cls){ const ar=sortKey===key?(sortDir==='asc'?' ‚Üë':' ‚Üì'):' ‚Üë‚Üì'; return <th className={cls||''} onClick={()=>setSort(key)}>{lbl}{ar}</th>; }
  return (
    <React.Fragment>
      <div className="section-title">üìä Transaction Data</div>
      <div className="kpis">
        <div className="kpi k1">Total Transactions<span className="n">{totalTx}</span></div>
        <div className="kpi k2">Total Spending<span className="n">‚Ç™{totalOutcome.toFixed(0)}</span></div>
        <div className="kpi k3">Categories<span className="n">{catCount}</span></div>
        <div className="kpi k1">Active Months<span className="n">{activeMonths}</span></div>
      </div>
      <div className="panel" style={{marginBottom:12}}>
        <div className="toolbar" style={{gap: 18}}>
          <div className="left" style={{display:'flex',alignItems:'center',gap:8}}>
            <input className="input-xs" type="text" placeholder="Search by name, category, notes‚Ä¶" value={q} onChange={(e)=>setQ(e.target.value)}/>
            <button className="btn btn-xs" onClick={()=>setQ('')}>Clear</button>
          </div>
          <div className="middle" style={{display:'flex',alignItems:'center',gap:8}}>
            <select className="input-xs" style={{minWidth:120}} value={filterCol} onChange={e=>setFilterCol(e.target.value)}>
              <option value="">Filter by‚Ä¶</option>
              <option value="tag">Tag</option>
              <option value="name">Name</option>
              <option value="category">Category</option>
              <option value="subcategory">Sub-category</option>
            </select>
            <input className="input-xs" style={{minWidth:140}} type="text" placeholder="Enter value‚Ä¶" value={filterVal} onChange={e=>setFilterVal(e.target.value)} disabled={!filterCol}/>
            {(filterCol||filterVal) && <button className="btn btn-xs" onClick={()=>{setFilterCol('');setFilterVal('');}}>Reset</button>}
          </div>
          <div className="right">
            <button className="btn btn-xs primary" onClick={save} disabled={saving}>{saving?'Saving‚Ä¶':'üíæ Save Changes'}</button>
          </div>
        </div>
      </div>
      <div className="panel">
        <table>
          <thead><tr>
            <th className="nosort">‚úñ</th>
            {hdr('Tag','tag','w-tag')}
            {hdr('Date','date','w-date')}
            {hdr('Name','name','w-name')}
            {hdr('Transaction Amount','amount','w-amt')}
            {hdr('Debit Amount (ILS)','debit','w-debit')}
            {hdr('Type','type')}
            {hdr('Category','category','w-cat')}
            {hdr('Sub-category','subcategory','w-sub')}
            <th className="nosort w-notes">Notes</th>
            <th className="nosort">Vi</th>
          </tr></thead>
          <tbody>
            {view.length? view.map((r,i)=>{
              const id=r.id||('p_'+i+'_'+(r.tag||'')+'_'+(r.date||'')+'_'+(r.name||'')); const currency=r.currency||'ILS';
              return (
                <tr key={id} className={r.vi?'row-vi':''}>
                  <td style={{width:48}}><button className="btn danger" onClick={()=>delRow(id)}>‚úñ</button></td>
                  <td className="w-tag"><input type="number" value={r.tag||''} onChange={(e)=>patch(id,{tag:Number(e.target.value||0)})}/></td>
                  <td className="w-date"><input type="text" value={r.date||''} onChange={(e)=>patch(id,{date:e.target.value})}/></td>
                  <td className="w-name" style={{textAlign:'center'}}>
                    <div className="cell-hscroll"><input className="fit" type="text" value={r.name||''} title={r.name||''} onChange={(e)=>patch(id,{name:e.target.value})}/></div>
                  </td>
                  <td className="w-amt">
                    <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:6}}>
                      <button className="currency-toggle" onClick={()=>toggleCurrency(id)}>{currency==='USD'?'$':'‚Ç™'}</button>
                      <input className="num-input" type="number" step="0.01" value={r.amount||0} onChange={(e)=>onAmount(id,e.target.value)}/>
                    </div>
                  </td>
                  <td className="w-debit"><input className="num-input" type="number" step="0.01" value={r.debit||0} onChange={(e)=>patch(id,{debit:Number(e.target.value||0)})}/></td>
                  <td><button className={'type-pill '+(r.type==='Expense'?'type-exp':'type-inc')} onClick={()=>toggleType(id)}>{r.type||'Expense'}</button></td>
                  <td className="w-cat"><select value={r.category||''} onChange={(e)=>patch(id,{category:e.target.value, subcategory:''})}><option value="">‚Äî Select ‚Äî</option>{Object.keys(categories||{}).sort((a,b)=>a.localeCompare(b)).map(c=><option key={c} value={c}>{c}</option>)}</select></td>
                  <td className="w-sub"><select value={r.subcategory||''} onChange={(e)=>patch(id,{subcategory:e.target.value})}><option value="">‚Äî Select ‚Äî</option>{((categories||{})[r.category]||[]).slice().sort((a,b)=>a.localeCompare(b)).map(s=><option key={s} value={s}>{s}</option>)}</select></td>
                  <td className="w-notes" style={{textAlign:'left'}}><input type="text" value={r.notes||''} onChange={(e)=>patch(id,{notes:e.target.value})}/></td>
                  <td><input type="checkbox" checked={!!r.vi} onChange={(e)=>patch(id,{vi:e.target.checked})}/></td>
                </tr>
              );
            }) : <tr><td colSpan="11" style={{textAlign:'center',color:'#6b7280'}}>No saved data yet.</td></tr>}
          </tbody>
        </table>
      </div>
    </React.Fragment>
  );
}


/* ---------- Summary (charts etc.) ---------- */
function SummaryTab({past,active}){
  const [err,setErr]=React.useState(''); const [selectedMonth,setSelectedMonth]=React.useState(''); const [subPieCat,setSubPieCat]=React.useState(''); const [expanded,setExpanded]=React.useState({});
  const mRef=React.useRef(null), nRef=React.useRef(null), catRef=React.useRef(null), subRef=React.useRef(null);
  const mChart=React.useRef(null), nChart=React.useRef(null), catPie=React.useRef(null), subPie=React.useRef(null);
  const agg=React.useMemo(()=>{ var monthsSet={}, mio={}, mcd={}; (past||[]).forEach(r=>{ var m=String(Number(r.tag||0)||0); if(m==='0') return; monthsSet[m]=1; var d=Number(r.debit||0); var inc=String(r.type||'').toLowerCase()==='income'; if(!mio[m]) mio[m]={income:0,outcome:0}; if(inc) mio[m].income+=d; else mio[m].outcome+=d; if(!inc){ if(!mcd[m]) mcd[m]={}; var cat=r.category||'Uncategorized', sub=r.subcategory||'‚Äî'; if(!mcd[m][cat]) mcd[m][cat]={total:0,subcategories:{}}; mcd[m][cat].total+=d; if(!mcd[m][cat].subcategories[sub]) mcd[m][cat].subcategories[sub]=0; mcd[m][cat].subcategories[sub]+=d; }}); var months=Object.keys(monthsSet).map(Number).sort((a,b)=>a-b).map(String); var monthNet={}; months.forEach(m=>{ var io=mio[m]||{income:0,outcome:0}; monthNet[m]={net:(io.income-io.outcome),income:io.income,outcome:io.outcome}; }); var outTotals=months.map(m=> (mio[m]&&mio[m].outcome)||0 ); return {months, mcd, monthNet, outTotals}; },[past]);
  const months=agg.months, monthCategoryData=agg.mcd, monthNet=agg.monthNet, outTotals=agg.outTotals;
  React.useEffect(()=>{ try{ if(!months.length){ setSelectedMonth(''); setSubPieCat(''); return; } var def=selectedMonth&&months.includes(selectedMonth)?selectedMonth:months[months.length-1]; setSelectedMonth(def); var cats=Object.keys(monthCategoryData[def]||{}); setSubPieCat(prev=> (prev && cats.includes(prev))?prev:(cats[0]||'')); }catch(e){ setErr('Init error: '+e.message);} },[months.join(','), JSON.stringify(monthCategoryData)]);
  React.useEffect(()=>{ try{
    if(!active) return;
    [mChart,nChart,catPie,subPie].forEach(R=>{ if(R.current && typeof R.current.destroy==='function'){ try{R.current.destroy();}catch(_){ } R.current=null; }});
    if(!months.length) return;
    var ChartLib=window.Chart, DLabels=window.ChartDataLabels; if(DLabels && !window.__mtDLReg){ ChartLib.register(DLabels); window.__mtDLReg=true; }
    const common={responsive:true, maintainAspectRatio:false};
    if(mRef.current){ const ctx=mRef.current.getContext('2d'); mChart.current=new ChartLib(ctx,{type:'bar',data:{labels:months,datasets:[{label:'Monthly Outcome (‚Ç™)',data:outTotals}]},options:Object.assign({},common,{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}})}); }
    if(nRef.current){ const ctx=nRef.current.getContext('2d'); const nvals=months.map(m=>(monthNet[m]&&monthNet[m].net)||0); nChart.current=new ChartLib(ctx,{type:'bar',data:{labels:months,datasets:[{label:'Net (‚Ç™)',data:nvals}]},options:Object.assign({},common,{plugins:{legend:{display:false},datalabels:DLabels?{formatter:(v)=>'‚Ç™'+Number(v).toFixed(0),anchor:'end',align:'top',clamp:true}:{}}})}); }
    const piePlugins={legend:{position:'right'}, datalabels:{display:false}};
    if(selectedMonth && catRef.current){ const ctx=catRef.current.getContext('2d'); const mcd=monthCategoryData[selectedMonth]||{}; const labels=Object.keys(mcd); const data=labels.map(k=>mcd[k].total); catPie.current=new ChartLib(ctx,{type:'pie',data:{labels,datasets:[{data}]},options:Object.assign({},common,{plugins:piePlugins})}); }
    if(selectedMonth && subPieCat && subRef.current){ const ctx=subRef.current.getContext('2d'); const mcd=monthCategoryData[selectedMonth]||{}; const subs=(mcd[subPieCat]&&mcd[subPieCat].subcategories)||{}; const labels=Object.keys(subs); const data=labels.map(k=>subs[k]); subPie.current=new ChartLib(ctx,{type:'pie',data:{labels,datasets:[{data}]},options:Object.assign({},common,{plugins:piePlugins})}); }
  }catch(e){ setErr('Chart error: '+e.message); } },[active, months.join(','), selectedMonth, subPieCat, JSON.stringify(monthCategoryData), JSON.stringify(monthNet)]);
  if(!(past||[]).length) return <div className="panel"><div>No data available. Upload data first.</div></div>;
  const monthCats=Object.keys(monthCategoryData[selectedMonth]||{}).sort((a,b)=>a.localeCompare(b));
  React.useEffect(()=>{ if(!selectedMonth) return; if(!monthCats.length){ setSubPieCat(''); return; } if(!subPieCat || !monthCats.includes(subPieCat)) setSubPieCat(monthCats[0]); },[selectedMonth, monthCats.join(',')]);
  return (
    <div className="panel">
      {err && <div className="panel" style={{background:'#fff7ed',border:'1px solid #fcd19c',color:'#92400e'}}>‚ö†Ô∏è {err}</div>}
      <div className="section-title">üìÖ Comparison Across Months</div>
      <div style={{overflowX:'auto'}}>
        <table>
          <thead><tr><th>Category</th>{months.map(m=><th key={'h'+m}>{m}</th>)}</tr></thead>
          <tbody>
            {(function(){
              const allCats=(function(){ var s={}; Object.keys(monthCategoryData).forEach(mm=>{ Object.keys(monthCategoryData[mm]).forEach(c=>s[c]=1); }); return Object.keys(s).sort((a,b)=>a.localeCompare(b)); })();
              if(!allCats.length) return <tr><td colSpan={months.length+1} className="muted" style={{textAlign:'center'}}>No outcome categories yet.</td></tr>;
              return allCats.map(cat=>{
                const exp=!!expanded[cat];
                return (
                  <React.Fragment key={cat}>
                    <tr>
                      <td><button className="btn btn-xs" onClick={()=>setExpanded(p=>Object.assign({},p,{[cat]:!p[cat]}))}>{exp?'‚ñæ':'‚ñ∏'}</button> <strong>{cat}</strong></td>
                      {months.map(m=>{ const cell=monthCategoryData[m]&&monthCategoryData[m][cat]; const v=cell?cell.total:0; return <td key={cat+'_'+m}><strong>{v?'‚Ç™'+v.toFixed(0):'‚Äî'}</strong></td>; })}
                    </tr>
                    {exp && (function(){
                      var subsSet={}; months.forEach(m=>{ var cell=monthCategoryData[m]&&monthCategoryData[m][cat]; if(cell){ Object.keys(cell.subcategories||{}).forEach(s=>subsSet[s]=1); }});
                      var subs=Object.keys(subsSet).sort((a,b)=>a.localeCompare(b));
                      return subs.map(s=>(
                        <tr key={cat+'__'+s}>
                          <td className="muted" style={{paddingLeft:42}}>‚Ü≥ {s}</td>
                          {months.map(m=>{ var cell=monthCategoryData[m]&&monthCategoryData[m][cat]; var v=cell?(cell.subcategories[s]||0):0; return <td key={cat+'_'+s+'_'+m}>{v?'‚Ç™'+v.toFixed(0):'‚Äî'}</td>; })}
                        </tr>
                      ));
                    })()}
                  </React.Fragment>
                );
              });
            })()}
            <tr>
              <td><strong>Net (Income ‚àí Outcome)</strong></td>
              {months.map(m=> <td key={'net_'+m}><strong>{'‚Ç™'+Number((monthNet[m]&&monthNet[m].net)||0).toFixed(0)}</strong></td>)}
            </tr>
          </tbody>
        </table>
      </div>

      <div className="grid-2" style={{marginTop:14}}>
        <div className="panel"><div className="section-title" style={{marginTop:0}}>üìä Monthly Outcome (‚Ç™)</div><div className="chart-box"><canvas ref={mRef}></canvas></div></div>
        <div className="panel"><div className="section-title" style={{marginTop:0}}>üìà Monthly Net (‚Ç™)</div><div className="chart-box"><canvas ref={nRef}></canvas></div></div>
      </div>

      <div className="section-title">üîé Details for Month</div>
      <div className="controls" style={{marginBottom:10}}>
        <select value={selectedMonth} onChange={(e)=>setSelectedMonth(e.target.value)}>{months.map(m=><option key={'m'+m} value={m}>{m}</option>)}</select>
        <span className="muted">Select month (tag) to focus below</span>
      </div>

      <div style={{overflowX:'auto', marginBottom:14}}>
        <table>
          <thead><tr><th>Category</th><th>Total (‚Ç™)</th></tr></thead>
          <tbody>
            {Object.keys(monthCategoryData[selectedMonth]||{}).length? Object.keys(monthCategoryData[selectedMonth]).sort((a,b)=>a.localeCompare(b)).map(cat=>{
              const cell=monthCategoryData[selectedMonth][cat]||{total:0,subcategories:{}}; const subs=cell.subcategories||{}; const total=cell.total||0; const key='m_'+selectedMonth+'_'+cat; const exp=!!expanded[key];
              return (
                <React.Fragment key={'mrow_'+cat}>
                  <tr>
                    <td><button className="btn btn-xs" onClick={()=>setExpanded(p=>Object.assign({},p,{[key]:!p[key]}))}>{exp?'‚ñæ':'‚ñ∏'}</button> <strong>{cat}</strong></td>
                    <td><strong>{'‚Ç™'+Number(total).toFixed(0)}</strong></td>
                  </tr>
                  {exp && Object.keys(subs).sort((a,b)=>a.localeCompare(b)).map(s=><tr key={'mrow_'+cat+'_'+s}><td className="muted" style={{paddingLeft:42}}>‚Ü≥ {s}</td><td>{'‚Ç™'+Number(subs[s]||0).toFixed(0)}</td></tr>)}
                </React.Fragment>
              );
            }) : <tr><td colSpan="2" style={{textAlign:'center'}} className="muted">No outcome categories in this month.</td></tr>}
          </tbody>
        </table>
      </div>

      <div className="controls" style={{marginBottom:10}}>
        <span className="muted">Sub-category pie for category:</span>
        <select value={subPieCat} onChange={(e)=>setSubPieCat(e.target.value)}>{monthCats.map(c=><option key={'spc_'+c} value={c}>{c}</option>)}</select>
      </div>

      <div className="grid-2">
        <div className="panel"><div className="section-title" style={{marginTop:0}}>üß© Categories (Outcome)</div><div className="chart-box"><canvas ref={catRef}></canvas></div></div>
        <div className="panel"><div className="section-title" style={{marginTop:0}}>üç∞ Sub-categories ‚Äî {subPieCat || '‚Äî'}</div><div className="chart-box"><canvas ref={subRef}></canvas></div></div>
      </div>
    </div>
  );
}

/* ---------- Settings (defined BEFORE App) ---------- */
function SettingsTab({ user, past, categories, stage, settings, onReload }){
  const [dateFormat,setDateFormat]=React.useState(settings.dateFormat||'YYYY-MM-DD');
  const [currency,setCurrency]=React.useState(settings.currency||'ILS');
  React.useEffect(()=>{ setDateFormat(settings.dateFormat||'YYYY-MM-DD'); setCurrency(settings.currency||'ILS'); },[settings.dateFormat,settings.currency]);

  function savePrefs(){ API.saveSettings({dateFormat,currency}).then(()=>alert('Preferences saved.')); }
  function exportAll(){
    const payload={ user, categories, past_data:past, current_month:stage, settings:{dateFormat,currency,theme:settings.theme||'light'} };
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`moneytron_${user}_export.json`; a.click(); URL.revokeObjectURL(a.href);
  }
  function onImport(e){
    const f=e.target.files&&e.target.files[0]; if(!f) return;
    const reader=new FileReader(); reader.onload=function(){ try{ const data=JSON.parse(reader.result); API.importData({categories:data.categories,past_data:data.past_data,current_month:data.current_month,settings:data.settings}).then(()=>{ alert('Imported successfully.'); onReload&&onReload(); }); }catch(err){ alert('Invalid file: '+err.message);} };
    reader.readAsText(f,'utf-8'); e.target.value='';
  }
  function clearAll(){ if(!confirm('Clear ALL data for this user? This cannot be undone.')) return; API.clearAll().then(()=>{ alert('All user data cleared.'); onReload&&onReload(); }); }

  // Simple account info
  const monthsSet={}; let lastTx=null, totalSpending=0;
  (past||[]).forEach(r=>{ const d=Number(r.debit||0); if(String(r.type||'').toLowerCase()!=='income') totalSpending+=d; const m=Number(r.tag||0); if(m>0) monthsSet[m]=1; if(r.date){ if(!lastTx || dayjs(r.date).isAfter(dayjs(lastTx.date))) lastTx=r; }});
  const avgMonthly=Object.keys(monthsSet).length? totalSpending/Object.keys(monthsSet).length : 0;
  const lastTxLabel=lastTx? `${lastTx.date} ‚Äî ${lastTx.name}` : 'No transactions yet';

  return (
    <div className="panel">
      <div className="section-title">‚öôÔ∏è Settings &amp; Profile for {user}</div>
      <div className="thin-underline"></div>
      <div className="section-sub">Manage your account, data, and application preferences.</div>

      <div className="grid-2">
        <div className="panel">
          <div className="section-title">üóÇÔ∏è Data Management</div>
          <div className="dm-grid">
            <div className="dm-left">
              <button className="btn" onClick={exportAll}>‚¨áÔ∏è Export All Data</button>
              <label className="btn">üì® Import Data<input type="file" accept="application/json,.json" style={{display:'none'}} onChange={onImport}/></label>
            </div>
            <div className="dm-right">
              <button className="btn danger" onClick={clearAll}>üßπ Clear All Data</button>
              <div className="danger-caption">‚ö†Ô∏è This action cannot be undone.</div>
            </div>
          </div>
        </div>

        <div className="panel">
          <div className="section-title">üß© Preferences</div>
          <div className="controls" style={{flexDirection:'column', alignItems:'stretch'}}>
            <label>Date Format</label>
            <select value={dateFormat} onChange={(e)=>setDateFormat(e.target.value)}>
              <option value="YYYY-MM-DD">YYYY-MM-DD ({dayjs().format('YYYY-MM-DD')})</option>
              <option value="DD/MM/YYYY">DD/MM/YYYY ({dayjs().format('DD/MM/YYYY')})</option>
              <option value="MM/DD/YYYY">MM/DD/YYYY ({dayjs().format('MM/DD/YYYY')})</option>
            </select>
            <label style={{marginTop:8}}>Currency</label>
            <select value={currency} onChange={(e)=>setCurrency(e.target.value)}>
              <option value="ILS">Israeli Shekel (‚Ç™)</option>
              <option value="USD">US Dollar ($)</option>
            </select>
            <div style={{marginTop:10}}><button className="btn primary" onClick={savePrefs}>Save Preferences</button></div>
          </div>
        </div>

        <div className="panel">
          <div className="section-title">üë§ Account Info</div>
          <div className="controls" style={{flexDirection:'column', alignItems:'flex-start'}}>
            <div><strong>Username:</strong> {user}</div>
            <div><strong>Avg Monthly Spending:</strong> ‚Ç™{avgMonthly.toFixed(0)}</div>
            <div><strong>Last Transaction:</strong> {lastTxLabel}</div>
            <div><strong>Data Storage:</strong> User-specific files</div>
          </div>
        </div>

        <div className="panel">
          <div className="section-title">‚ÑπÔ∏è App Information</div>
          <ul style={{marginTop:6}}>
            <li>MoneyTron Multi-User v1.0</li>
            <li>Multi-user support</li>
            <li>Personal categories</li>
            <li>Monthly workflow</li>
            <li>Data visualization</li>
            <li>Export/Import capabilities</li>
            <li>Privacy: All data stored securely on your server.</li>
          </ul>
        </div>
      </div>
    </div>
  );
}

/* ------------------------------- App ------------------------------- */
function App(){
  const [user,setUser]=React.useState(null);
  const [tab,setTab]=React.useState('transactions'); // first screen: Transactions
  const [categories,setCategories]=React.useState({});
  const [past,setPast]=React.useState([]);
  const [stage,setStage]=React.useState([]);
  const [settings,setSettings]=React.useState({dateFormat:'YYYY-MM-DD', currency:'ILS'});

  // never auto-login
  React.useEffect(()=>{ API.logout().catch(()=>{}); },[]);

  function reload(){
    return API.bootstrap().then(d=>{
      setUser(d.user||''); setCategories(asCategories(d.categories)); setPast(asArray(d.past_data)); setStage(asArray(d.current_month));
    }).then(()=> API.getSettings().then(s=>setSettings(s)).catch(()=>{}));
  }
  function doLogin(name){ API.login(name).then(()=>{ setUser(name); setTab('transactions'); return reload(); }).catch(err=>alert('Login failed: '+err.message)); }

  if(!user) return <LoginView onLogin={doLogin}/>;

  function tabBtn(id,label,icon){ return <button className={'tab'+(tab===id?' active':'')} onClick={()=>{ if(tab==='transactions'){ API.saveStage(stage).catch(()=>{}); } setTab(id); }}>{icon} {label}</button>; }
  function onSavedTx(){ reload().then(()=> setTab('data')); }

  return (
    <div className="wrap">
      <h1 className="title">MoneyTron ‚Äî Multi-User Money Tracker</h1>
      <div className="frame">
        <TitleBar user={user} onSwitch={()=>{ API.logout().then(()=>setUser(null)); }}/>
        <div className="tabs">
          {tabBtn('transactions','Transactions','üí∞')}
          {tabBtn('summary','Summary','üìä')}
          {tabBtn('data','Data','üìÑ')}
          {tabBtn('categories','Categories','üìö')}
          {tabBtn('settings','Settings','‚öôÔ∏è')}
        </div>

        {tab==='transactions' && <TransactionsTab rows={stage} setRows={setStage} categories={categories} onSaved={onSavedTx}/>}
        {tab==='data' && <DataTab past={past} categories={categories} onSaved={(next)=>setPast(next)} />}
        {tab==='summary' && <SummaryTab past={past} active={tab==='summary'}/>}
        {tab==='categories' && <CategoriesTab user={user} categories={categories} onSaved={(next)=>setCategories(next)} />}
        {tab==='settings' && <SettingsTab user={user} past={past} categories={categories} stage={stage} settings={settings} onReload={reload}/>}
      </div>
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>